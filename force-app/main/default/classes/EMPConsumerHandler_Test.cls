/*
* Author   : Ayush 
* Purpose  : Utility test class for consuming Shipment Data. 
*
* Revision Ref Number  Date        Owner                   Description
* -------- ----------  ----------- -------------------     -----------
* 1.0      SC-5462     29-Aug-2022 Ayush Kumar             Created.
* 2.0      SC-5864     28-Feb-2023 Vivek Agarwal           Added new methods to publish geography event data
* 3.0      SC-8987     28-Dec-2023 Raksha N                New Test framework implemented
* 4.0      SC-9586     05-Feb-2024  Richa@Maersk           Added Shipment Cancelled event consumption method 
* 5.0      SC-9600     20-Feb-2024  Shahanawaz@Maersk      Updated testShipmentInsert to consume tag01a0 and field Cargo type
* 6.0      SC-9950     19-March-2024 Vivek@Maersk          updated consumeEMPEvents to fetch data for tag0900 and tag0910 for BKS value
*/

@isTest
public class EMPConsumerHandler_Test {
    @testSetup
    public static void setup(){
        List<Geography__c> listGeography = new List<Geography__c>();
        List<Account> listAccount = new List<Account>();
        List<Contact> listContact = new List<Contact>();
        
        Geography__c geography = TestBusinessHelper.createGeography('Savannah', 'Country', null, 'SV', true);
        geography.GEO_ID__c='1JUKNJGWHQBNJ';
        listGeography.add(geography);
        
        Geography__c geography1 = TestBusinessHelper.createGeography('India', 'Country', null, 'IN', true);
        geography1.GEO_ID__c='0FW19NDUZ2NI7';
        listGeography.add(geography1);
        update listGeography;
        
        Account acc = TestBusinessHelper.createAccount('Draft_Account', false);
        acc.Id = null;
        acc.Name = 'Test Account Shipment1';
        acc.Country__c = geography.Id;
        acc.SCV_Code__c ='331s4019201';
        listAccount.add(acc);
        
        Account acc1 = TestBusinessHelper.createAccount('Draft_Account', false);
        acc1.Id = null;
        acc1.Name = 'New Test Account Shipment2';
        acc1.Country__c = geography1.Id;
        acc1.SCV_Code__c ='33524019202';
        listAccount.add(acc1);
        insert listAccount;
        
        Contact con = TestBusinessHelper.createContact(acc, 'Customer_Contact', BrandUtilities.MAERSKLINE, false);
        con.Id = null;
        con.Country__c = acc.Country__c;
        con.Contact_Status__c = 'Active';
        listContact.add(con);      
        
        Contact con1 = TestBusinessHelper.createContact(acc1, 'Customer_Contact', BrandUtilities.MAERSKLINE, false);
        con1.Id = null;
        con1.FirstName='Test Cont';
        con1.Email='test@rak.com';
        con1.Phone='+44 123456';
        con1.Unique_User_ID__c='12345';
        con1.Country__c = acc1.Country__c;
        con1.Contact_Status__c = 'Active';
        listContact.add(con1);
        insert listContact;        
    }
    
    @isTest
    // Test for creating EMP Events Object. Test Method for EMPConsumerHandler and related classes.
    public static void consumeEMPEvents() {
        //to consume shipment events
        Shipment_Event__e thisEvent =  ShipmentTestData.shipmentTestData2();
        List<ShipmentJsonParser> testShipmentParserList = new List<ShipmentJsonParser>();
        String testJsonStr = thisEvent.Json_1__c; 
        ShipmentJsonParser testShipment = ShipmentJsonParser.parse(testJsonStr);
        if(testshipment.eventName == 'Confirm_Shipment_Closed'){       
            testShipmentParserList.add(testShipment);
        }
        Test.startTest();
        EMPConsumerHandler.processShipmentData(testShipmentParserList);
        // EMPConsumerHandler.processGeographyData(testGeographyParserList);
        Test.stopTest();
        
        List<Shipment__c> ship= [SELECT Id, Shipment_Number__c FROM Shipment__c limit 1];
        System.assertEquals(1, ship.size()); //Check if the Shipment Number is inserted
        
        // Shipment_Event__e thisEvent1 =  ShipmentTestData.shipmentTestData3();
        Shipment_Event__e thisEvent1 =  new Shipment_Event__e();
        thisEvent1.Json_1__c='{"eventName": "Confirm_Shipment_Closed_TPDOC", "parserName": "GDS", "parserVersion": "73.0",'+
            '"tag0000": [ { "dateSent": "20210809", "timeSent": "1408", "sender": "GCSS", "receiver": "Message Broker", "messageReference": "", "applicationReference": "", "gcssReference": "", "kind": "O", "dateReceived": "", "timeReceived": "", "replyRequested": "N", "messageTypeCode": "TPDOC", "testFlag": "", "ediReceiver": "", "ediAppRefNum": "", "version": "74.0",'+
            '"tag2100": [ { "instanceId": "CYPLWE2U70IIB", "extReferenceId": "", "keyExchangeId": "", "kind": "O", "updateStrucTime": "2021-08-09 14.07.54.003278", "updateStrucUser": "0591D4744", "isIssued": "N", "isHitchment": "N", "isSwitch": "", "fkUAdmOperatorOwner": "2", "uAdmOperatorOwner": "SAF", "fkCommunicationMediaTypeSi": "", "communicationMediaTypeSi": "", "documentClassId": "", "documentClass": "", "createTime": "2021-08-09 13.57.54.100648", "createUser": "0591D4744", "updateTime": "2021-08-09 14.07.54.003278", "updateUser": "0591D4744", "versionCreateTime": "2021-08-09 13.57.54.100648", "versionCreateUser": "0591D4744", "versionUpdateTime": "2021-08-09 14.06.59.274153", "versionUpdateUser": "0591D4744", "fkShipmentVersionProduct": "3UOESE2U70IIB", "loadPortRoutePointSequence": "1", "fkDocumentType": "", "documentType": "", "fkCommunicationMediaTypeDi": "", "communicationMediaTypeDi": "", "fkTransportDocMaster": "", "isHouse": "N", "isTransportDocLevelPrinting": "N", "fkUAdmTeamAssigned": "7472", "teamName": "Centre Systems - Ord. Handling (Saf)", "fkBusinessUnit": "2842", "businessUnit": "MAERSK LINE A/S  (SAF)", "businessUnitCode": "DKCPHSAF1", "isHouseMaster": "N", "transportDocVersionInstanceId": "36TMWE2U70IIB", "fkTpdocAddressGroup": "UAXLWE2U70IIB", "userAssigned": "0591D4744", "isCscsIssued": "N", "extShipmentVersionProduct": "", "extTpDocAddressGroup": "", "uAdmOperatorOwnerScac": "SAFM", "fkBusinessSystemInvoice": "5", "businessSystemInvoice": "GCSS", "isImportShipmentTpdoc": "N", "isOnceIssued": "", "preventAutoIssue": "", "useRfsPort": "N", "complianceRequired": "Y", "advancedManifestWarning": "N", "fkShipmentVersionPricing": "3UOESE2U70IIB",'+
            '"tag2120": [ { "instanceId": "J3OIUE2U70IIB", "extReferenceId": "", "keyExchangeId": "", "kind": "O", "fkShipmentPartyOwner": "2FPCUE2U70IIB", "extShipmentPartyOwner": "", "fkHiLevelPartyOwner": "", "extHiLevelPartyOwner": "", "sequenceInOwnerObject": "0", "fkEntityTypeReferenceType": "1", "entityTypeReferenceType": "Booking Number", "referenceEntityIdentifier": "", "extReferenceEntityIdentifier": "", "referenceString": "203622227", "createTime": "2021-08-09 13.57.54.100648", "createUser": "0591D4744", "updateTime": "2021-08-09 13.57.54.100648", "updateUser": "0591D4744", "fkShipmentVersion": "3UOESE2U70IIB", "extShipmentVersion": "", "fkTransportDocVersion": "", "extTransportDocVersion": "", "fkEntityType": "101", "entityType": "Shipment" }, { "instanceId": "XB0PWE2U70IIB", "extReferenceId": "", "keyExchangeId": "", "kind": "O", "fkShipmentPartyOwner": "", "extShipmentPartyOwner": "", "fkHiLevelPartyOwner": "", "extHiLevelPartyOwner": "", "sequenceInOwnerObject": "0", "fkEntityTypeReferenceType": "5", "entityTypeReferenceType": "Transport Document Number", "referenceEntityIdentifier": "", "extReferenceEntityIdentifier": "", "referenceString": "203622227", "createTime": "2021-08-09 13.57.54.100648", "createUser": "0591D4744", "updateTime": "2021-08-09 13.57.54.100648", "updateUser": "0591D4744", "fkShipmentVersion": "", "extShipmentVersion": "", "fkTransportDocVersion": "36TMWE2U70IIB", "extTransportDocVersion": "", "fkEntityType": "151", "entityType": "Transport_Doc" } ],'+
            '"tag2200": [ { "instanceId": "3K5IDI2U70KIB", "extReferenceId": "", "keyExchangeId": "", "kind": "O", "custno": "10000007951", "name": "GCSS BOOKED BY", "address": "2 - DAMPFAERGEVEJ rnSL6 PAKHUS D, 2ND FLOOR rn rnCOPENHAGEN OE Denmark", "cuname": "GCSS BOOKED BY", "cuadr1": "DAMPFAERGEVEJ", "cuadr2": "PAKHUS D, 2ND FLOOR", "cuadr3": "", "cuadr4": "", "fkGeoAreaCityCode": "", "cityName": "COPENHAGEN OE", "state": "", "zipCode": "2100", "countryCode": "", "createTime": "2021-08-09 14.00.01.618162", "createUser": "0591D4744", "updateTime": "2021-08-09 14.07.54.003278", "updateUser": "0591D4744", "countryName": "Denmark", "addressName": "", "streetNo": "2", "poBox": "SL6", "phone": "4523361151", "fax": "", "importFax": "", "emailAddress": "alwaysonwebops@maersk.com", "url": "http://www.maerskline.com/", "docAddress": "", "fkPartyRoleSpecialText": "", "partyRoleSpecialText": "", "fkPaymentTermTypeAutoPop": "", "paymentTermTypeAutoPop": "", "fkPartyRoleType": "22", "partyRoleType": "Transport Document Receiver", "printableAddress1": "2 - DAMPFAERGEVEJ", "printableAddress2": "SL6 PAKHUS D, 2ND FLOOR", "printableAddress3": "", "printableAddress4": "COPENHAGEN OE Denmark", "fkGeoAreaCityId": "", "geoAreaCityName": "COPENHAGEN OE", "rkstCityCode": "", "fkGeoAreaCountryId": "3D9XA9RMF1PJ2", "geoAreaCountryName": "Denmark", "rkstCountryCode": "DK", "fkShipmentVersion": "", "extShipmentVersion": "", "fkTransportDocVersion": "36TMWE2U70IIB", "extTransportDocVersion": "", "dodaacId": "ABC123", "fofmc": "", "negotiableBl": "", "nonNegotiableWaybill": "", "customsId": "", "extCmdCustomerId": "DK00007951",'+
            '"tag2220": [ { "instanceId": "CICKDI2U70KIB", "extReferenceId": "", "keyExchangeId": "", "kind": "O", "custno": "10000700342", "contactPersonName": " Sgl Con", "phoneNo": "", "faxNo": "", "emailAddress": "", "createTime": "2021-08-09 14.00.01.618162", "createUser": "0591D4744", "updateTime": "2021-08-09 14.00.01.618162", "updateUser": "0591D4744", "presentationSequence": "0", "contactName": " Sgl Con", "jobTitle": "Sales Director", "phone": "", "fax": "", "email": "fernandezallyssa147@gmail.com", "cellPhone": "", "initials": "", "sex": "", "homePhone": "", "homeEmail": "fernandezallyssa147@gmail.com", "extCmdContactId": "DK00700342" } ],'+
            '"tag2240": [ { "instanceId": "3MWJDI2U70KIB", "extReferenceId": "", "keyExchangeId": "", "kind": "O", "address1": "DAMPFAERGEVEJ", "address2": "PAKHUS D, 2ND FLOOR", "address3": "", "addressName": "", "city": "COPENHAGEN OE", "country": "Denmark", "dodaacId": "ABC123", "emailAddress": "alwaysonwebops@maersk.com", "fax": "", "fkHaulageSite": "", "extHaulageSite": "", "fkShipmentParty": "3K5IDI2U70KIB", "extShipmentParty": "", "importFax": "", "name": "GCSS BOOKED BY", "phone": "4523361151", "poBox": "SL6", "printableAddress1": "2 - DAMPFAERGEVEJ", "printableAddress2": "SL6 PAKHUS D, 2ND FLOOR", "printableAddress3": "", "printableAddress4": "COPENHAGEN OE Denmark", "state": "", "streetNo": "2", "url": "http://www.maerskline.com/", "zipCity": "", "zipCode": "2100", "createTime": "2021-08-09 14.00.01.618162", "createUser": "0591D4744", "updateTime": "2021-08-09 14.00.01.618162", "updateUser": "0591D4744" } ] }, { "instanceId": "2FPCUE2U70IIB", "extReferenceId": "", "keyExchangeId": "", "kind": "O", "custno": "10000007951", "name": "GCSS BOOKED BY", "address": "2 - DAMPFAERGEVEJ rnSL6 PAKHUS D, 2ND FLOOR rn rnCOPENHAGEN OE Denmark", "cuname": "GCSS BOOKED BY", "cuadr1": "DAMPFAERGEVEJ", "cuadr2": "PAKHUS D, 2ND FLOOR", "cuadr3": "", "cuadr4": "", "fkGeoAreaCityCode": "", "cityName": "COPENHAGEN OE", "state": "", "zipCode": "2100", "countryCode": "", "createTime": "2021-08-09 13.57.54.100648", "createUser": "0591D4744", "updateTime": "2021-08-09 14.07.54.003278", "updateUser": "0591D4744", "countryName": "Denmark", "addressName": "", "streetNo": "2", "poBox": "SL6", "phone": "4523361151", "fax": "", "importFax": "", "emailAddress": "alwaysonwebops@maersk.com", "url": "http://www.maerskline.com/", "docAddress": "", "fkPartyRoleSpecialText": "", "partyRoleSpecialText": "", "fkPaymentTermTypeAutoPop": "", "paymentTermTypeAutoPop": "", "fkPartyRoleType": "1", "partyRoleType": "Booked By", "printableAddress1": "2 - DAMPFAERGEVEJ", "printableAddress2": "SL6 PAKHUS D, 2ND FLOOR", "printableAddress3": "", "printableAddress4": "COPENHAGEN OE Denmark", "fkGeoAreaCityId": "", "geoAreaCityName": "COPENHAGEN OE", "rkstCityCode": "", "fkGeoAreaCountryId": "3D9XA9RMF1PJ2", "geoAreaCountryName": "Denmark", "rkstCountryCode": "DK", "fkShipmentVersion": "3UOESE2U70IIB", "extShipmentVersion": "", "fkTransportDocVersion": "", "extTransportDocVersion": "", "dodaacId": "ABC123", "fofmc": "", "negotiableBl": "", "nonNegotiableWaybill": "", "customsId": "", "extCmdCustomerId": "DK00007951",'+
            '"tag2220": [ { "instanceId": "HNLEUE2U70IIB", "extReferenceId": "", "keyExchangeId": "", "kind": "O", "custno": "10000700342", "contactPersonName": " Sgl Con", "phoneNo": "", "faxNo": "", "emailAddress": "", "createTime": "2021-08-09 13.57.54.100648", "createUser": "0591D4744", "updateTime": "2021-08-09 14.00.01.618162", "updateUser": "0591D4744", "presentationSequence": "0", "contactName": " Sgl Con", "jobTitle": "Sales Director", "phone": "", "fax": "", "email": "fernandezallyssa147@gmail.com", "cellPhone": "", "initials": "", "sex": "", "homePhone": "", "homeEmail": "fernandezallyssa147@gmail.com", "extCmdContactId": "DK00700342" } ],'+
            '"tag2240": [ { "instanceId": "YOEDUE2U70IIB", "extReferenceId": "", "keyExchangeId": "", "kind": "O", "address1": "DAMPFAERGEVEJ", "address2": "PAKHUS D, 2ND FLOOR", "address3": "", "addressName": "", "city": "COPENHAGEN OE", "country": "Denmark", "dodaacId": "ABC123", "emailAddress": "alwaysonwebops@maersk.com", "fax": "", "fkHaulageSite": "", "extHaulageSite": "", "fkShipmentParty": "2FPCUE2U70IIB", "extShipmentParty": "", "importFax": "", "name": "GCSS BOOKED BY", "phone": "4523361151", "poBox": "SL6", "printableAddress1": "2 - DAMPFAERGEVEJ", "printableAddress2": "SL6 PAKHUS D, 2ND FLOOR", "printableAddress3": "", "printableAddress4": "COPENHAGEN OE Denmark", "state": "", "streetNo": "2", "url": "http://www.maerskline.com/", "zipCity": "", "zipCode": "2100", "createTime": "2021-08-09 13.57.54.100648", "createUser": "0591D4744", "updateTime": "2021-08-09 14.00.01.618162", "updateUser": "0591D4744" } ] }, { "instanceId": "RWSFDI2U70KIB", "extReferenceId": "", "keyExchangeId": "", "kind": "O", "custno": "10000007951", "name": "GCSS BOOKED BY", "address": "2 - DAMPFAERGEVEJ rnSL6 PAKHUS D, 2ND FLOOR rn rnCOPENHAGEN OE Denmark", "cuname": "GCSS BOOKED BY", "cuadr1": "DAMPFAERGEVEJ", "cuadr2": "PAKHUS D, 2ND FLOOR", "cuadr3": "", "cuadr4": "", "fkGeoAreaCityCode": "", "cityName": "COPENHAGEN OE", "state": "", "zipCode": "2100", "countryCode": "", "createTime": "2021-08-09 14.00.01.618162", "createUser": "0591D4744", "updateTime": "2021-08-09 14.07.54.003278", "updateUser": "0591D4744", "countryName": "Denmark", "addressName": "", "streetNo": "2", "poBox": "SL6", "phone": "4523361151", "fax": "", "importFax": "", "emailAddress": "alwaysonwebops@maersk.com", "url": "http://www.maerskline.com/", "docAddress": "", "fkPartyRoleSpecialText": "", "partyRoleSpecialText": "", "fkPaymentTermTypeAutoPop": "", "paymentTermTypeAutoPop": "", "fkPartyRoleType": "14", "partyRoleType": "Invoice Party", "printableAddress1": "2 - DAMPFAERGEVEJ", "printableAddress2": "SL6 PAKHUS D, 2ND FLOOR", "printableAddress3": "", "printableAddress4": "COPENHAGEN OE Denmark", "fkGeoAreaCityId": "", "geoAreaCityName": "COPENHAGEN OE", "rkstCityCode": "", "fkGeoAreaCountryId": "3D9XA9RMF1PJ2", "geoAreaCountryName": "Denmark", "rkstCountryCode": "DK", "fkShipmentVersion": "3UOESE2U70IIB", "extShipmentVersion": "", "fkTransportDocVersion": "", "extTransportDocVersion": "", "dodaacId": "ABC123", "fofmc": "", "negotiableBl": "", "nonNegotiableWaybill": "", "customsId": "", "extCmdCustomerId": "DK00007951",'+
            '"tag2220": [ { "instanceId": "XARGDI2U70KIB", "extReferenceId": "", "keyExchangeId": "", "kind": "O", "custno": "10000700342", "contactPersonName": " Sgl Con", "phoneNo": "", "faxNo": "", "emailAddress": "", "createTime": "2021-08-09 14.00.01.618162", "createUser": "0591D4744", "updateTime": "2021-08-09 14.00.01.618162", "updateUser": "0591D4744", "presentationSequence": "0", "contactName": " Sgl Con", "jobTitle": "Sales Director", "phone": "", "fax": "", "email": "fernandezallyssa147@gmail.com", "cellPhone": "", "initials": "", "sex": "", "homePhone": "", "homeEmail": "fernandezallyssa147@gmail.com", "extCmdContactId": "DK00700342" } ],'+
            '"tag2240": [ { "instanceId": "MOEGDI2U70KIB", "extReferenceId": "", "keyExchangeId": "", "kind": "O", "address1": "DAMPFAERGEVEJ", "address2": "PAKHUS D, 2ND FLOOR", "address3": "", "addressName": "", "city": "COPENHAGEN OE", "country": "Denmark", "dodaacId": "ABC123", "emailAddress": "alwaysonwebops@maersk.com", "fax": "", "fkHaulageSite": "", "extHaulageSite": "", "fkShipmentParty": "RWSFDI2U70KIB", "extShipmentParty": "", "importFax": "", "name": "GCSS BOOKED BY", "phone": "4523361151", "poBox": "SL6", "printableAddress1": "2 - DAMPFAERGEVEJ", "printableAddress2": "SL6 PAKHUS D, 2ND FLOOR", "printableAddress3": "", "printableAddress4": "COPENHAGEN OE Denmark", "state": "", "streetNo": "2", "url": "http://www.maerskline.com/", "zipCity": "", "zipCode": "2100", "createTime": "2021-08-09 14.00.01.618162", "createUser": "0591D4744", "updateTime": "2021-08-09 14.00.01.618162", "updateUser": "0591D4744" } ] }, { "instanceId": "IN9PTE2U70IIB", "extReferenceId": "", "keyExchangeId": "", "kind": "O", "custno": "10000007951", "name": "GCSS BOOKED BY", "address": "2 - DAMPFAERGEVEJ rnSL6 PAKHUS D, 2ND FLOOR rn rnCOPENHAGEN OE Denmark", "cuname": "GCSS BOOKED BY", "cuadr1": "DAMPFAERGEVEJ", "cuadr2": "PAKHUS D, 2ND FLOOR", "cuadr3": "", "cuadr4": "", "fkGeoAreaCityCode": "", "cityName": "COPENHAGEN OE", "state": "", "zipCode": "2100", "countryCode": "", "createTime": "2021-08-09 13.57.54.100648", "createUser": "0591D4744", "updateTime": "2021-08-09 14.07.54.003278", "updateUser": "0591D4744", "countryName": "Denmark", "addressName": "", "streetNo": "2", "poBox": "SL6", "phone": "4523361151", "fax": "", "importFax": "", "emailAddress": "alwaysonwebops@maersk.com", "url": "http://www.maerskline.com/", "docAddress": "", "fkPartyRoleSpecialText": "", "partyRoleSpecialText": "", "fkPaymentTermTypeAutoPop": "", "paymentTermTypeAutoPop": "", "fkPartyRoleType": "2", "partyRoleType": "Contractual Customer", "printableAddress1": "2 - DAMPFAERGEVEJ", "printableAddress2": "SL6 PAKHUS D, 2ND FLOOR", "printableAddress3": "", "printableAddress4": "COPENHAGEN OE Denmark", "fkGeoAreaCityId": "", "geoAreaCityName": "COPENHAGEN OE", "rkstCityCode": "", "fkGeoAreaCountryId": "3D9XA9RMF1PJ2", "geoAreaCountryName": "Denmark", "rkstCountryCode": "DK", "fkShipmentVersion": "3UOESE2U70IIB", "extShipmentVersion": "", "fkTransportDocVersion": "", "extTransportDocVersion": "", "dodaacId": "ABC123", "fofmc": "", "negotiableBl": "", "nonNegotiableWaybill": "", "customsId": "", "extCmdCustomerId": "DK00007951",'+
            '"tag2220": [ { "instanceId": "NRLSTE2U70IIB", "extReferenceId": "", "keyExchangeId": "", "kind": "O", "custno": "10000700342", "contactPersonName": " Sgl Con", "phoneNo": "", "faxNo": "", "emailAddress": "", "createTime": "2021-08-09 13.57.54.100648", "createUser": "0591D4744", "updateTime": "2021-08-09 14.00.01.618162", "updateUser": "0591D4744", "presentationSequence": "0", "contactName": " Sgl Con", "jobTitle": "Sales Director", "phone": "", "fax": "", "email": "fernandezallyssa147@gmail.com", "cellPhone": "", "initials": "", "sex": "", "homePhone": "", "homeEmail": "fernandezallyssa147@gmail.com", "extCmdContactId": "DK00700342" } ],'+
            '"tag2240": [ { "instanceId": "5Z3RTE2U70IIB", "extReferenceId": "", "keyExchangeId": "", "kind": "O", "address1": "DAMPFAERGEVEJ", "address2": "PAKHUS D, 2ND FLOOR", "address3": "", "addressName": "", "city": "COPENHAGEN OE", "country": "Denmark", "dodaacId": "ABC123", "emailAddress": "alwaysonwebops@maersk.com", "fax": "", "fkHaulageSite": "", "extHaulageSite": "", "fkShipmentParty": "IN9PTE2U70IIB", "extShipmentParty": "", "importFax": "", "name": "GCSS BOOKED BY", "phone": "4523361151", "poBox": "SL6", "printableAddress1": "2 - DAMPFAERGEVEJ", "printableAddress2": "SL6 PAKHUS D, 2ND FLOOR", "printableAddress3": "", "printableAddress4": "COPENHAGEN OE Denmark", "state": "", "streetNo": "2", "url": "http://www.maerskline.com/", "zipCity": "", "zipCode": "2100", "createTime": "2021-08-09 13.57.54.100648", "createUser": "0591D4744", "updateTime": "2021-08-09 14.00.01.618162", "updateUser": "0591D4744" } ] }, { "instanceId": "8C3MDI2U70KIB", "extReferenceId": "", "keyExchangeId": "", "kind": "O", "custno": "10000007951", "name": "GCSS BOOKED BY", "address": "2 - DAMPFAERGEVEJ rnSL6 PAKHUS D, 2ND FLOOR rn rnCOPENHAGEN OE Denmark", "cuname": "GCSS BOOKED BY", "cuadr1": "DAMPFAERGEVEJ", "cuadr2": "PAKHUS D, 2ND FLOOR", "cuadr3": "", "cuadr4": "", "fkGeoAreaCityCode": "", "cityName": "COPENHAGEN OE", "state": "", "zipCode": "2100", "countryCode": "", "createTime": "2021-08-09 14.00.01.618162", "createUser": "0591D4744", "updateTime": "2021-08-09 14.07.54.003278", "updateUser": "0591D4744", "countryName": "Denmark", "addressName": "", "streetNo": "2", "poBox": "SL6", "phone": "4523361151", "fax": "", "importFax": "", "emailAddress": "alwaysonwebops@maersk.com", "url": "http://www.maerskline.com/", "docAddress": "", "fkPartyRoleSpecialText": "", "partyRoleSpecialText": "", "fkPaymentTermTypeAutoPop": "", "paymentTermTypeAutoPop": "", "fkPartyRoleType": "26", "partyRoleType": "Credit Party", "printableAddress1": "2 - DAMPFAERGEVEJ", "printableAddress2": "SL6 PAKHUS D, 2ND FLOOR", "printableAddress3": "", "printableAddress4": "COPENHAGEN OE Denmark", "fkGeoAreaCityId": "", "geoAreaCityName": "COPENHAGEN OE", "rkstCityCode": "", "fkGeoAreaCountryId": "3D9XA9RMF1PJ2", "geoAreaCountryName": "Denmark", "rkstCountryCode": "DK", "fkShipmentVersion": "3UOESE2U70IIB", "extShipmentVersion": "", "fkTransportDocVersion": "", "extTransportDocVersion": "", "dodaacId": "ABC123", "fofmc": "", "negotiableBl": "", "nonNegotiableWaybill": "", "customsId": "", "extCmdCustomerId": "DK00007951",'+
            '"tag2220": [ { "instanceId": "Y76NDI2U70KIB", "extReferenceId": "", "keyExchangeId": "", "kind": "O", "custno": "10000700342", "contactPersonName": " Sgl Con", "phoneNo": "", "faxNo": "", "emailAddress": "", "createTime": "2021-08-09 14.00.01.618162", "createUser": "0591D4744", "updateTime": "2021-08-09 14.00.01.618162", "updateUser": "0591D4744", "presentationSequence": "0", "contactName": " Sgl Con", "jobTitle": "Sales Director", "phone": "", "fax": "", "email": "fernandezallyssa147@gmail.com", "cellPhone": "", "initials": "", "sex": "", "homePhone": "", "homeEmail": "fernandezallyssa147@gmail.com", "extCmdContactId": "DK00700342" } ],'+
            '"tag2240": [ { "instanceId": "V8PNDI2U70KIB", "extReferenceId": "", "keyExchangeId": "", "kind": "O", "address1": "DAMPFAERGEVEJ", "address2": "PAKHUS D, 2ND FLOOR", "address3": "", "addressName": "", "city": "COPENHAGEN OE", "country": "Denmark", "dodaacId": "ABC123", "emailAddress": "alwaysonwebops@maersk.com", "fax": "", "fkHaulageSite": "", "extHaulageSite": "", "fkShipmentParty": "8C3MDI2U70KIB", "extShipmentParty": "", "importFax": "", "name": "GCSS BOOKED BY", "phone": "4523361151", "poBox": "SL6", "printableAddress1": "2 - DAMPFAERGEVEJ", "printableAddress2": "SL6 PAKHUS D, 2ND FLOOR", "printableAddress3": "", "printableAddress4": "COPENHAGEN OE Denmark", "state": "", "streetNo": "2", "url": "http://www.maerskline.com/", "zipCity": "", "zipCode": "2100", "createTime": "2021-08-09 14.00.01.618162", "createUser": "0591D4744", "updateTime": "2021-08-09 14.00.01.618162", "updateUser": "0591D4744" } ] }, { "instanceId": "4ORRCI2U70KIB", "extReferenceId": "", "keyExchangeId": "", "kind": "O", "custno": "10000007951", "name": "GCSS BOOKED BY", "address": "2 - DAMPFAERGEVEJ rnSL6 PAKHUS D, 2ND FLOOR rn rnCOPENHAGEN OE Denmark", "cuname": "GCSS BOOKED BY", "cuadr1": "DAMPFAERGEVEJ", "cuadr2": "PAKHUS D, 2ND FLOOR", "cuadr3": "", "cuadr4": "", "fkGeoAreaCityCode": "", "cityName": "COPENHAGEN OE", "state": "", "zipCode": "2100", "countryCode": "", "createTime": "2021-08-09 14.00.01.618162", "createUser": "0591D4744", "updateTime": "2021-08-09 14.07.54.003278", "updateUser": "0591D4744", "countryName": "Denmark", "addressName": "", "streetNo": "2", "poBox": "SL6", "phone": "4523361151", "fax": "", "importFax": "", "emailAddress": "alwaysonwebops@maersk.com", "url": "http://www.maerskline.com/", "docAddress": "", "fkPartyRoleSpecialText": "", "partyRoleSpecialText": "", "fkPaymentTermTypeAutoPop": "", "paymentTermTypeAutoPop": "", "fkPartyRoleType": "3", "partyRoleType": "Shipper", "printableAddress1": "2 - DAMPFAERGEVEJ", "printableAddress2": "SL6 PAKHUS D, 2ND FLOOR", "printableAddress3": "", "printableAddress4": "COPENHAGEN OE Denmark", "fkGeoAreaCityId": "", "geoAreaCityName": "COPENHAGEN OE", "rkstCityCode": "", "fkGeoAreaCountryId": "3D9XA9RMF1PJ2", "geoAreaCountryName": "Denmark", "rkstCountryCode": "DK", "fkShipmentVersion": "3UOESE2U70IIB", "extShipmentVersion": "", "fkTransportDocVersion": "", "extTransportDocVersion": "", "dodaacId": "ABC123", "fofmc": "", "negotiableBl": "", "nonNegotiableWaybill": "", "customsId": "", "extCmdCustomerId": "DK00007951",'+
            '"tag2220": [ { "instanceId": "6XOTCI2U70KIB", "extReferenceId": "", "keyExchangeId": "", "kind": "O", "custno": "10000700342", "contactPersonName": " Sgl Con", "phoneNo": "", "faxNo": "", "emailAddress": "", "createTime": "2021-08-09 14.00.01.618162", "createUser": "0591D4744", "updateTime": "2021-08-09 14.00.01.618162", "updateUser": "0591D4744", "presentationSequence": "0", "contactName": " Sgl Con", "jobTitle": "Sales Director", "phone": "", "fax": "", "email": "fernandezallyssa147@gmail.com", "cellPhone": "", "initials": "", "sex": "", "homePhone": "", "homeEmail": "fernandezallyssa147@gmail.com", "extCmdContactId": "DK00700342" } ],'+
            '"tag2240": [ { "instanceId": "7B6SCI2U70KIB", "extReferenceId": "", "keyExchangeId": "", "kind": "O", "address1": "DAMPFAERGEVEJ", "address2": "PAKHUS D, 2ND FLOOR", "address3": "", "addressName": "", "city": "COPENHAGEN OE", "country": "Denmark", "dodaacId": "ABC123", "emailAddress": "alwaysonwebops@maersk.com", "fax": "", "fkHaulageSite": "", "extHaulageSite": "", "fkShipmentParty": "4ORRCI2U70KIB", "extShipmentParty": "", "importFax": "", "name": "GCSS BOOKED BY", "phone": "4523361151", "poBox": "SL6", "printableAddress1": "2 - DAMPFAERGEVEJ", "printableAddress2": "SL6 PAKHUS D, 2ND FLOOR", "printableAddress3": "", "printableAddress4": "COPENHAGEN OE Denmark", "state": "", "streetNo": "2", "url": "http://www.maerskline.com/", "zipCity": "", "zipCode": "2100", "createTime": "2021-08-09 14.00.01.618162", "createUser": "0591D4744", "updateTime": "2021-08-09 14.00.01.618162", "updateUser": "0591D4744" } ] }, { "instanceId": "MUECDI2U70KIB", "extReferenceId": "", "keyExchangeId": "", "kind": "O", "custno": "10000007951", "name": "GCSS BOOKED BY", "address": "2 - DAMPFAERGEVEJ rnSL6 PAKHUS D, 2ND FLOOR rn rnCOPENHAGEN OE Denmark", "cuname": "GCSS BOOKED BY", "cuadr1": "DAMPFAERGEVEJ", "cuadr2": "PAKHUS D, 2ND FLOOR", "cuadr3": "", "cuadr4": "", "fkGeoAreaCityCode": "", "cityName": "COPENHAGEN OE", "state": "", "zipCode": "2100", "countryCode": "", "createTime": "2021-08-09 14.00.01.618162", "createUser": "0591D4744", "updateTime": "2021-08-09 14.07.54.003278", "updateUser": "0591D4744", "countryName": "Denmark", "addressName": "", "streetNo": "2", "poBox": "SL6", "phone": "4523361151", "fax": "", "importFax": "", "emailAddress": "alwaysonwebops@maersk.com", "url": "http://www.maerskline.com/", "docAddress": "", "fkPartyRoleSpecialText": "", "partyRoleSpecialText": "", "fkPaymentTermTypeAutoPop": "", "paymentTermTypeAutoPop": "", "fkPartyRoleType": "4", "partyRoleType": "Consignee", "printableAddress1": "2 - DAMPFAERGEVEJ", "printableAddress2": "SL6 PAKHUS D, 2ND FLOOR", "printableAddress3": "", "printableAddress4": "COPENHAGEN OE Denmark", "fkGeoAreaCityId": "", "geoAreaCityName": "COPENHAGEN OE", "rkstCityCode": "", "fkGeoAreaCountryId": "3D9XA9RMF1PJ2", "geoAreaCountryName": "Denmark", "rkstCountryCode": "DK", "fkShipmentVersion": "3UOESE2U70IIB", "extShipmentVersion": "", "fkTransportDocVersion": "", "extTransportDocVersion": "", "dodaacId": "ABC123", "fofmc": "", "negotiableBl": "", "nonNegotiableWaybill": "", "customsId": "", "extCmdCustomerId": "DK00007951",'+
            '"tag2220": [ { "instanceId": "VVVDDI2U70KIB", "extReferenceId": "", "keyExchangeId": "", "kind": "O", "custno": "10000700342", "contactPersonName": " Sgl Con", "phoneNo": "", "faxNo": "", "emailAddress": "", "createTime": "2021-08-09 14.00.01.618162", "createUser": "0591D4744", "updateTime": "2021-08-09 14.00.01.618162", "updateUser": "0591D4744", "presentationSequence": "0", "contactName": " Sgl Con", "jobTitle": "Sales Director", "phone": "", "fax": "", "email": "fernandezallyssa147@gmail.com", "cellPhone": "", "initials": "", "sex": "", "homePhone": "", "homeEmail": "fernandezallyssa147@gmail.com", "extCmdContactId": "DK00700342" } ],'+
            '"tag2240": [ { "instanceId": "6AHDDI2U70KIB", "extReferenceId": "", "keyExchangeId": "", "kind": "O", "address1": "DAMPFAERGEVEJ", "address2": "PAKHUS D, 2ND FLOOR", "address3": "", "addressName": "", "city": "COPENHAGEN OE", "country": "Denmark", "dodaacId": "ABC123", "emailAddress": "alwaysonwebops@maersk.com", "fax": "", "fkHaulageSite": "", "extHaulageSite": "", "fkShipmentParty": "MUECDI2U70KIB", "extShipmentParty": "", "importFax": "", "name": "GCSS BOOKED BY", "phone": "4523361151", "poBox": "SL6", "printableAddress1": "2 - DAMPFAERGEVEJ", "printableAddress2": "SL6 PAKHUS D, 2ND FLOOR", "printableAddress3": "", "printableAddress4": "COPENHAGEN OE Denmark", "state": "", "streetNo": "2", "url": "http://www.maerskline.com/", "zipCity": "", "zipCode": "2100", "createTime": "2021-08-09 14.00.01.618162", "createUser": "0591D4744", "updateTime": "2021-08-09 14.00.01.618162", "updateUser": "0591D4744" } ] }, { "instanceId": "YVMMCI2U70KIB", "extReferenceId": "", "keyExchangeId": "", "kind": "O", "custno": "10000007951", "name": "GCSS BOOKED BY", "address": "2 - DAMPFAERGEVEJ rnSL6 PAKHUS D, 2ND FLOOR rn rnCOPENHAGEN OE Denmark", "cuname": "GCSS BOOKED BY", "cuadr1": "DAMPFAERGEVEJ", "cuadr2": "PAKHUS D, 2ND FLOOR", "cuadr3": "", "cuadr4": "", "fkGeoAreaCityCode": "", "cityName": "COPENHAGEN OE", "state": "", "zipCode": "2100", "countryCode": "", "createTime": "2021-08-09 14.00.01.618162", "createUser": "0591D4744", "updateTime": "2021-08-09 14.07.54.003278", "updateUser": "0591D4744", "countryName": "Denmark", "addressName": "", "streetNo": "2", "poBox": "SL6", "phone": "4523361151", "fax": "", "importFax": "", "emailAddress": "alwaysonwebops@maersk.com", "url": "http://www.maerskline.com/", "docAddress": "", "fkPartyRoleSpecialText": "", "partyRoleSpecialText": "", "fkPaymentTermTypeAutoPop": "", "paymentTermTypeAutoPop": "", "fkPartyRoleType": "44", "partyRoleType": "Price Owner", "printableAddress1": "2 - DAMPFAERGEVEJ", "printableAddress2": "SL6 PAKHUS D, 2ND FLOOR", "printableAddress3": "", "printableAddress4": "COPENHAGEN OE Denmark", "fkGeoAreaCityId": "", "geoAreaCityName": "COPENHAGEN OE", "rkstCityCode": "", "fkGeoAreaCountryId": "3D9XA9RMF1PJ2", "geoAreaCountryName": "Denmark", "rkstCountryCode": "DK", "fkShipmentVersion": "3UOESE2U70IIB", "extShipmentVersion": "", "fkTransportDocVersion": "", "extTransportDocVersion": "", "dodaacId": "ABC123", "fofmc": "", "negotiableBl": "", "nonNegotiableWaybill": "", "customsId": "", "extCmdCustomerId": "DK00007951",'+
            '"tag2220": [ { "instanceId": "QO4NCI2U70KIB", "extReferenceId": "", "keyExchangeId": "", "kind": "O", "custno": "10000700342", "contactPersonName": " Sgl Con", "phoneNo": "", "faxNo": "", "emailAddress": "", "createTime": "2021-08-09 14.00.01.618162", "createUser": "0591D4744", "updateTime": "2021-08-09 14.00.01.618162", "updateUser": "0591D4744", "presentationSequence": "0", "contactName": " Sgl Con", "jobTitle": "Sales Director", "phone": "", "fax": "", "email": "fernandezallyssa147@gmail.com", "cellPhone": "", "initials": "", "sex": "", "homePhone": "", "homeEmail": "fernandezallyssa147@gmail.com", "extCmdContactId": "DK00700342" } ],'+
            '"tag2240": [ { "instanceId": "UGLNCI2U70KIB", "extReferenceId": "", "keyExchangeId": "", "kind": "O", "address1": "DAMPFAERGEVEJ", "address2": "PAKHUS D, 2ND FLOOR", "address3": "", "addressName": "", "city": "COPENHAGEN OE", "country": "Denmark", "dodaacId": "ABC123", "emailAddress": "alwaysonwebops@maersk.com", "fax": "", "fkHaulageSite": "", "extHaulageSite": "", "fkShipmentParty": "YVMMCI2U70KIB", "extShipmentParty": "", "importFax": "", "name": "GCSS BOOKED BY", "phone": "4523361151", "poBox": "SL6", "printableAddress1": "2 - DAMPFAERGEVEJ", "printableAddress2": "SL6 PAKHUS D, 2ND FLOOR", "printableAddress3": "", "printableAddress4": "COPENHAGEN OE Denmark", "state": "", "streetNo": "2", "url": "http://www.maerskline.com/", "zipCity": "", "zipCode": "2100", "createTime": "2021-08-09 14.00.01.618162", "createUser": "0591D4744", "updateTime": "2021-08-09 14.00.01.618162", "updateUser": "0591D4744" } ] }, { "instanceId": "O9IUTE2U70IIB", "extReferenceId": "", "keyExchangeId": "", "kind": "O", "custno": "10000007951", "name": "GCSS BOOKED BY", "address": "2 - DAMPFAERGEVEJ rnSL6 PAKHUS D, 2ND FLOOR rn rnCOPENHAGEN OE Denmark", "cuname": "GCSS BOOKED BY", "cuadr1": "DAMPFAERGEVEJ", "cuadr2": "PAKHUS D, 2ND FLOOR", "cuadr3": "", "cuadr4": "", "fkGeoAreaCityCode": "", "cityName": "COPENHAGEN OE", "state": "", "zipCode": "2100", "countryCode": "", "createTime": "2021-08-09 13.57.54.100648", "createUser": "0591D4744", "updateTime": "2021-08-09 14.07.54.003278", "updateUser": "0591D4744", "countryName": "Denmark", "addressName": "", "streetNo": "2", "poBox": "SL6", "phone": "4523361151", "fax": "", "importFax": "", "emailAddress": "", "url": "http://www.maerskline.com/", "docAddress": "", "fkPartyRoleSpecialText": "", "partyRoleSpecialText": "", "fkPaymentTermTypeAutoPop": "", "paymentTermTypeAutoPop": "", "fkPartyRoleType": "7", "partyRoleType": "Allocation Owner", "printableAddress1": "2 - DAMPFAERGEVEJ", "printableAddress2": "SL6 PAKHUS D, 2ND FLOOR", "printableAddress3": "", "printableAddress4": "COPENHAGEN OE Denmark", "fkGeoAreaCityId": "", "geoAreaCityName": "COPENHAGEN OE", "rkstCityCode": "", "fkGeoAreaCountryId": "3D9XA9RMF1PJ2", "geoAreaCountryName": "Denmark", "rkstCountryCode": "DK", "fkShipmentVersion": "3UOESE2U70IIB", "extShipmentVersion": "", "fkTransportDocVersion": "", "extTransportDocVersion": "", "dodaacId": "ABC123", "fofmc": "", "negotiableBl": "", "nonNegotiableWaybill": "", "customsId": "", "extCmdCustomerId": "DK00007951",'+
            '"tag2220": [ { "instanceId": "ZTEBUE2U70IIB", "extReferenceId": "", "keyExchangeId": "", "kind": "O", "custno": "10000700342", "contactPersonName": " Sgl Con", "phoneNo": "", "faxNo": "", "emailAddress": "", "createTime": "2021-08-09 13.57.54.100648", "createUser": "0591D4744", "updateTime": "2021-08-09 13.57.54.100648", "updateUser": "0591D4744", "presentationSequence": "0", "contactName": " Sgl Con", "jobTitle": "Sales Director", "phone": "", "fax": "", "email": "fernandezallyssa147@gmail.com", "cellPhone": "", "initials": "", "sex": "", "homePhone": "", "homeEmail": "fernandezallyssa147@gmail.com", "extCmdContactId": "DK00700342" } ],'+
            '"tag2240": [ { "instanceId": "F9PAUE2U70IIB", "extReferenceId": "", "keyExchangeId": "", "kind": "O", "address1": "DAMPFAERGEVEJ", "address2": "PAKHUS D, 2ND FLOOR", "address3": "", "addressName": "", "city": "COPENHAGEN OE", "country": "Denmark", "dodaacId": "ABC123", "emailAddress": "", "fax": "", "fkHaulageSite": "", "extHaulageSite": "", "fkShipmentParty": "O9IUTE2U70IIB", "extShipmentParty": "", "importFax": "", "name": "GCSS BOOKED BY", "phone": "4523361151", "poBox": "SL6", "printableAddress1": "2 - DAMPFAERGEVEJ", "printableAddress2": "SL6 PAKHUS D, 2ND FLOOR", "printableAddress3": "", "printableAddress4": "COPENHAGEN OE Denmark", "state": "", "streetNo": "2", "url": "http://www.maerskline.com/", "zipCity": "", "zipCode": "2100", "createTime": "2021-08-09 13.57.54.100648", "createUser": "0591D4744", "updateTime": "2021-08-09 13.57.54.100648", "updateUser": "0591D4744" } ] } ] } ] } ]'+
            '}';
        List<TpDocJsonParser> testTPDocParserList = new List<TpDocJsonParser>();
        String testJsonStr1 = thisEvent1.Json_1__c; 
        TpDocJsonParser testTpDocEvent = TpDocJsonParser.parse(testJsonStr1);
        if(testTpDocEvent.eventName == 'Confirm_Shipment_Closed_TPDOC'){           
            testTPDocParserList.add(testTpDocEvent);
        }
        EMPConsumerHandler.processTPDocEventData(testTPDocParserList);
        System.assertEquals(ship[0].Shipment_Number__c, testTPDocParserList[0].tag0000[0].tag2100[0].tag2120[0].referenceString); //Check if the Shipment Number is associated with TP doc number
    }  
    
    // Test for publishing a shipment Event. Test Method for ShipmentEventHandler    
    @isTest
    public static void testShipmentInsert() {
        Shipment_Event__e thisEvent =  ShipmentTestData.shipmentTestData1();
        Test.startTest();
        // Publish test event
        Database.SaveResult sr = EventBus.publish(thisEvent);
        // Verify SaveResult value
        System.assertEquals(true, sr.isSuccess());
        Test.stopTest();
    }
    
    @isTest
    public static void getDateValueFromEpocDays() {
        EMPConsumerHandler.getDateValueFromEpocDays(1391529600);
        EMPConsumerHandler.getDateTimeValue('1391529600');
        EMPConsumerHandler.getDateValue('1391529600');
    }
    
    
    // Test for publishing a cancelled shipment Event.
    @isTest
    public static void testCancelledShipmentInsert() {
        Shipment_Event__e thisEvent =  ShipmentTestData.shipmentCancelledTestData();
        Test.startTest();
        Database.SaveResult sr = EventBus.publish(thisEvent);
        System.assertEquals(true, sr.isSuccess());
        Test.stopTest();
    }
    
    @isTest   
    public static void consumeCancelledShipmentEvents() {
        //to consume shipment cancelled events
        Shipment_Event__e evt =  ShipmentTestData.shipmentCancelledTestData();
        List<ShipmentCancelledJsonParser> lstShipCancelledParser= new List<ShipmentCancelledJsonParser>();
        String jsonStr = evt.Json_1__c; 
        ShipmentCancelledJsonParser shp = ShipmentCancelledJsonParser.parse(jsonStr);    
        if(shp.HeaderEventType.headerEventTypeName == 'ShipmentCancelled'){       
            lstShipCancelledParser.add(shp);
        }
        Test.startTest();
        EMPConsumerHandler.processShipmentCancelledEventData(lstShipCancelledParser);       
        Test.stopTest();
        
        List<Shipment__c> ship= [SELECT Id, Shipment_Number__c FROM Shipment__c limit 1];
        System.assertEquals(1, ship.size()); //Check if the Shipment  is inserted
    }  
    
}